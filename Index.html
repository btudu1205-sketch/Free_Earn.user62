<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monetag Earn Bot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #4CAF50;
      --secondary-color: #2196F3;
      --background-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-color: #333333;
      --border-radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: var(--background-color);
      color: var(--text-color);
      padding-bottom: 70px;
    }
    .container {
      padding: 20px;
      max-width: 500px;
      margin: auto;
    }
    nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      max-width: 500px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      justify-content: space-around;
      background: var(--card-bg);
      border-top: 1px solid #e0e0e0;
      z-index: 1000;
      box-shadow: var(--shadow);
      border-radius: 15px 15px 0 0;
    }
    nav button {
      flex: 1;
      padding: 12px 8px;
      font-size: 10px;
      background: none;
      border: none;
      color: #777;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: color 0.3s ease;
      position: relative;
      cursor: pointer;
    }
    nav button.active-nav {
      color: var(--primary-color);
    }
    nav button.active-nav::after {
      content: '';
      position: absolute;
      top: -1px;
      height: 3px;
      width: 60%;
      background: var(--primary-color);
      border-radius: 0 0 5px 5px;
    }
    nav button i {
      font-size: 20px;
      margin-bottom: 4px;
    }
    .section {
      display: none;
      animation: fadeIn 0.5s ease-in-out;
      padding: 20px;
    }
    .section.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .card {
      background: var(--card-bg);
      padding: 20px;
      margin-bottom: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .card h3 {
      margin: 0;
      font-size: 16px;
      color: #555;
    }
    .card .value {
      font-size: 24px;
      font-weight: 600;
      color: var(--primary-color);
    }
    .btn {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: none;
      border-radius: var(--border-radius);
      color: white;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    .btn:active {
      transform: scale(0.98);
    }
    .btn-primary { background: var(--primary-color); }
    .btn-secondary { background: var(--secondary-color); }
    .btn-admin { background: #FF9800; }
    .btn-owner { background: #F44336; }
    .btn-terms { background: #9E9E9E; }
    input {
      width: calc(100% - 20px);
      padding: 12px 10px;
      margin-bottom: 15px;
      border-radius: var(--border-radius);
      border: 1px solid #ddd;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    input:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    h2 {
      text-align: center;
      color: #444;
      margin-bottom: 25px;
      font-size: 24px;
      font-weight: 600;
    }
    .icon { margin-right: 10px; }
    .task-item {
      background: #e9f5e9;
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 10px;
    }
    .task-item span {
      display: block;
      margin-bottom: 10px;
    }
    .task-item form { margin-top: 10px; }
    .task-link {
      display: block;
      margin-top: 10px;
      text-align: center;
      text-decoration: none;
      color: var(--secondary-color);
    }
    .task-link i { margin-right: 5px; }
    .auth-container {
      max-width: 400px;
      margin: 50px auto;
      padding: 20px;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      text-align: center;
    }
    .auth-container h2 { margin-bottom: 20px; }
    .auth-container p { margin-top: 20px; }
    .hidden { display: none !important; }
    .modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 350px;
      border-radius: var(--border-radius);
      text-align: center;
    }
    .close-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-btn:hover, .close-btn:focus {
      color: black;
      text-decoration: none;
    }
    .modal-content input {
      margin-top: 10px;
      text-align: center;
      font-size: 20px;
      letter-spacing: 5px;
    }
  </style>
</head>
<body>

<div id="authSections">
    <div id="registerSection" class="auth-container">
        <h2><i class="fas fa-user-plus"></i> Register</h2>
        <form id="registerForm" onsubmit="handleRegistration(event)">
            <input type="email" id="reg_email" placeholder="Email" required>
            <input type="password" id="reg_password" placeholder="Password (min 8 characters)" required>
            <input type="text" id="reg_username" placeholder="Telegram Username (@username)" required>
            <input type="text" id="reg_chat_id" placeholder="Telegram Chat ID (10 digits)" required>
            <button type="submit" class="btn btn-primary">Register</button>
        </form>
        <p>Already have an account? <a href="#" onclick="showLogin()">Login here</a></p>
    </div>

    <div id="loginSection" class="auth-container hidden">
        <h2><i class="fas fa-sign-in-alt"></i> Login</h2>
        <form id="loginForm" onsubmit="handleLogin(event)">
            <input type="email" id="login_email" placeholder="Email" required>
            <input type="password" id="login_password" placeholder="Password" required>
            <button type="submit" class="btn btn-primary">Login</button>
        </form>
        <p>Don't have an account? <a href="#" onclick="showRegister()">Register here</a></p>
    </div>
</div>

<div id="verificationModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h2>Enter Verification Code</h2>
    <p>We've sent a 4-digit code to your Telegram.</p>
    <form onsubmit="verifyCode(event)">
      <input type="text" id="verificationCodeInput" maxlength="4" required>
      <button type="submit" class="btn btn-primary">Verify</button>
    </form>
  </div>
</div>

<div id="mainApp" class="container hidden">
  <div id="home" class="section active">
    <h2><i class="fas fa-home icon"></i>Dashboard</h2>
    <div class="card"><h3>Balance</h3><span class="value" id="balance">0</span></div>
    <div class="card"><h3>Total Withdraw</h3><span class="value" id="withdraw">0</span></div>
    <div class="card"><h3>Total Tasks</h3><span class="value" id="tasks">0</span></div>
    <div class="card"><h3>Ads Watched</h3><span class="value" id="ads">0</span></div>
  </div>

  <div id="earn" class="section">
    <h2><i class="fas fa-dollar-sign icon"></i>Earn</h2>
    <button class="btn btn-primary" onclick="showRewardedAd()"><i class="fas fa-video icon"></i>Watch Ads</button>
    <div id="adbox" style="margin:20px 0;"></div>
    <button class="btn btn-secondary" onclick="showTasks()"><i class="fas fa-tasks icon"></i>Complete Tasks</button>
    <div id="taskList" style="margin-top: 20px;"></div>
  </div>

  <div id="withdrawSection" class="section">
    <h2><i class="fas fa-wallet icon"></i>Withdraw</h2>
    <form onsubmit="submitWithdraw(event)">
      <input type="text" id="number" placeholder="Your Number (Bkash/Nagad)" required>
      <input type="number" id="amount" placeholder="Amount" required>
      <p style="text-align:center; margin-top:0; color: #555;">Minimum Withdraw: <span id="minWithdrawAmount">0</span></p>
      <button type="submit" class="btn btn-primary">Submit Withdraw</button>
    </form>
  </div>

  <div id="context" class="section">
    <h2><i class="fas fa-headset icon"></i>Support & Info</h2>
    <a href="#" id="adminLink" target="_blank" style="text-decoration: none;">
      <button class="btn btn-admin"><i class="fab fa-telegram-plane icon"></i>Admin Support</button>
    </a>
    <a href="#" id="ownerLink" target="_blank" style="text-decoration: none;">
      <button class="btn btn-owner"><i class="fab fa-telegram-plane icon"></i>Owner Support</button>
    </a>
    <a href="#" id="termsLink" target="_blank" style="text-decoration: none;">
      <button class="btn btn-terms"><i class="fas fa-file-contract icon"></i>Terms & Conditions</button>
    </a>
  </div>

  <div id="profile" class="section">
    <h2><i class="fas fa-user-circle icon"></i>Profile</h2>
    <div class="card"><h3>Email</h3><span class="value" id="profileEmail" style="font-size:16px;"><b>Guest</b></span></div>
    <div class="card"><h3>Total Withdraw</h3><span class="value" id="profileWithdraw">0</span></div>
    <div class="card"><h3>Total Tasks</h3><span class="value" id="profileTasks">0</span></div>
    <div class="card"><h3>Total Ads Watched</h3><span class="value" id="profileAds">0</span></div>
  </div>
</div>

<nav id="appNav">
  <button onclick="showSection('home', this)" class="active-nav"><i class="fas fa-home"></i><span>Home</span></button>
  <button onclick="showSection('earn', this)"><i class="fas fa-dollar-sign"></i><span>Earn</span></button>
  <button onclick="showSection('withdrawSection', this)"><i class="fas fa-wallet"></i><span>Withdraw</span></button>
  <button onclick="showSection('context', this)"><i class="fas fa-headset"></i><span>Support</span></button>
  <button onclick="showSection('profile', this)"><i class="fas fa-user-circle"></i><span>Profile</span></button>
  <button onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
  // Your Firebase configuration here
  const firebaseConfig = {
    apiKey: "AIzaSyCjqCkvQf_E8Nch3-sJbzLskIc8qgTEwcc",
    authDomain: "earn-to-7bd9a.firebaseapp.com",
    databaseURL: "https://earn-to-7bd9a-default-rtdb.firebaseio.com",
    projectId: "earn-to-7bd9a",
    storageBucket: "earn-to-7bd9a.firebasestorage.app",
    messagingSenderId: "1086733479022",
    appId: "1:1086733479022:web:8642ba43995641b9340a7f",
    measurementId: "G-YHP7Y0FPT2"
  };

  // Your Telegram and Monetag Details
  const BOT_TOKEN = '8254257053:AAG3D7CaqN1FtQ7Ltl2NVF_q85ZarmiZwFs';
  const CHAT_ID = '5965219037';
  const MONETAG_ZONE_ID = '9572158';

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  let verificationCode = null;
  let tempUserData = {};
  let adminConfig = {}; // NEW: To store config from Firebase

  // --- Telegram functions --- (No change)
  function sendTelegramNotification(chatId, message) {
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(message)}&parse_mode=HTML`;
    fetch(url).then(response => response.json()).then(data => {
      if (!data.ok) console.error("Failed to send Telegram message:", data.description);
    }).catch(error => console.error("Error sending Telegram message:", error));
  }
  function sendTelegramImageNotification(chatId, imageFile, caption) {
    const formData = new FormData();
    formData.append('chat_id', chatId);
    formData.append('photo', imageFile);
    formData.append('caption', caption);
    const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`;
    fetch(url, { method: 'POST', body: formData }).then(response => response.json()).then(data => {
      if (!data.ok) console.error("Failed to send image:", data.description);
    }).catch(error => console.error("Error sending image:", error));
  }

  // --- Modal functions --- (No change)
  function showModal() { document.getElementById('verificationModal').style.display = 'block'; }
  function closeModal() { document.getElementById('verificationModal').style.display = 'none'; }

  // --- UI management ---
  function updateUI(user) {
    const authSections = document.getElementById('authSections');
    const mainApp = document.getElementById('mainApp');
    const appNav = document.getElementById('appNav');
    if (user) {
      authSections.classList.add('hidden');
      mainApp.classList.remove('hidden');
      appNav.style.display = 'flex';
      loadUserData(user);
      loadAdminData(); // NEW: Load admin config
    } else {
      authSections.classList.remove('hidden');
      mainApp.classList.add('hidden');
      appNav.style.display = 'none';
      showRegister();
    }
  }
  
  // NEW: Load admin data from Firebase
  function loadAdminData() {
      database.ref('config').once('value').then(snapshot => {
          adminConfig = snapshot.val();
          if (adminConfig) {
              document.getElementById('adminLink').href = adminConfig.adminLink || '#';
              document.getElementById('ownerLink').href = adminConfig.ownerLink || '#';
              document.getElementById('termsLink').href = adminConfig.termsLink || '#';
              document.getElementById('minWithdrawAmount').innerText = adminConfig.minWithdraw || 0;
          }
      });
  }

  function showLogin() {
    document.getElementById('loginSection').classList.remove('hidden');
    document.getElementById('registerSection').classList.add('hidden');
  }
  function showRegister() {
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('registerSection').classList.remove('hidden');
  }

  // --- Firebase Auth & Data Handling ---
  auth.onAuthStateChanged(user => {
    updateUI(user);
    if(user) {
      document.getElementById('profileEmail').innerHTML = `<b>${user.email}</b>`;
    }
  });

  function handleRegistration(e) {
    e.preventDefault();
    const email = document.getElementById('reg_email').value;
    const password = document.getElementById('reg_password').value;
    const telegramUsername = document.getElementById('reg_username').value;
    const telegramChatId = document.getElementById('reg_chat_id').value;

    if (password.length < 8) { alert("❌ Password must be at least 8 characters long."); return; }
    if (!telegramUsername.startsWith('@')) { alert("❌ Telegram Username must start with '@'."); return; }
    if (telegramChatId.length !== 10) { alert("❌ Telegram Chat ID must be exactly 10 digits long."); return; }

    auth.fetchSignInMethodsForEmail(email).then(methods => {
      if (methods.length > 0) {
        alert("❌ This email is already registered.");
      } else {
        verificationCode = Math.floor(1000 + Math.random() * 9000).toString();
        sendTelegramNotification(telegramChatId, `Your verification code is: <b>${verificationCode}</b>`);
        tempUserData = { email, password, username: telegramUsername, chatId: telegramChatId, balance: 0, withdraw: 0, tasks: 0, ads: 0 };
        showModal();
      }
    });
  }

  function verifyCode(e) {
    e.preventDefault();
    const submittedCode = document.getElementById('verificationCodeInput').value;
    if (submittedCode === verificationCode) {
      auth.createUserWithEmailAndPassword(tempUserData.email, tempUserData.password)
        .then((userCredential) => {
          const user = userCredential.user;
          database.ref('users/' + user.uid).set({
            username: tempUserData.username,
            chatId: tempUserData.chatId,
            balance: tempUserData.balance,
            withdraw: tempUserData.withdraw,
            tasks: tempUserData.tasks,
            ads: tempUserData.ads
          });
          alert("✅ Registration successful!");
          closeModal();
          showLogin();
        })
        .catch((error) => alert(`❌ Registration failed: ${error.message}`));
      verificationCode = null;
      tempUserData = {};
      document.getElementById('verificationCodeInput').value = '';
    } else {
      alert("❌ Incorrect verification code.");
    }
  }

  function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('login_email').value;
    const password = document.getElementById('login_password').value;
    auth.signInWithEmailAndPassword(email, password)
      .then((userCredential) => console.log('Login successful!'))
      .catch((error) => alert(`❌ Login failed: ${error.message}`));
  }

  function logout() {
    auth.signOut().then(() => console.log('Logout successful!')).catch((error) => console.error('Logout failed:', error));
  }

  function loadUserData(user) {
    const userRef = database.ref('users/' + user.uid);
    userRef.on('value', (snapshot) => {
      const userData = snapshot.val() || { balance: 0, withdraw: 0, tasks: 0, ads: 0 };
      document.getElementById("balance").innerText = userData.balance;
      document.getElementById("withdraw").innerText = userData.withdraw;
      document.getElementById("tasks").innerText = userData.tasks;
      document.getElementById("ads").innerText = userData.ads;
      document.getElementById("profileWithdraw").innerText = userData.withdraw;
      document.getElementById("profileTasks").innerText = userData.tasks;
      document.getElementById("profileAds").innerText = userData.ads;
    });
  }
    
  function showSection(id, element) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active-nav"));
    if (element) {
        element.classList.add("active-nav");
    }
  }

  function showRewardedAd() {
    const user = auth.currentUser;
    if (!user) { alert("❌ Please login first."); return; }
    const showAd = window[`show_${MONETAG_ZONE_ID}`];
    if (showAd) {
      showAd().then(() => {
        const userRef = database.ref('users/' + user.uid);
        userRef.transaction((currentData) => {
          if (currentData) {
            currentData.balance = (currentData.balance || 0) + 10;
            currentData.ads = (currentData.ads || 0) + 1;
          }
          return currentData;
        });
        alert("✅ You earned 10 points!");
      }).catch(error => {
        console.error("Ad failed to show:", error);
        alert("❌ Ad could not be loaded. Please try again.");
      });
    } else {
      alert("❌ Ad script not loaded. Please refresh the page.");
    }
  }

  // MODIFIED: This function now loads tasks from Firebase
  function showTasks() {
    const taskListDiv = document.getElementById("taskList");
    taskListDiv.innerHTML = "<h4><i class='fas fa-spinner fa-spin'></i> Loading tasks...</h4>"; // Loading indicator
    
    database.ref('tasks').once('value').then(snapshot => {
        const tasks = snapshot.val();
        if (tasks) {
            taskListDiv.innerHTML = ""; // Clear loading indicator
            Object.keys(tasks).forEach(key => {
                const task = tasks[key];
                const taskHtml = `
                    <div class="task-item">
                        <span><b>${task.title}</b></span>
                        <p>Reward: ${task.points} points</p>
                        <a href="${task.link}" target="_blank" class="btn btn-secondary">
                            <i class="${task.icon}"></i> Go to Task
                        </a>
                        <form onsubmit="submitTask(event, ${task.points}, '${task.title}')">
                            <input type="file" accept="image/*" required>
                            <button type="submit" class="btn btn-primary">Submit Screenshot</button>
                        </form>
                    </div>`;
                taskListDiv.innerHTML += taskHtml;
            });
        } else {
            taskListDiv.innerHTML = "<p>No tasks available right now. Check back later!</p>";
        }
    }).catch(error => {
        console.error("Error loading tasks:", error);
        taskListDiv.innerHTML = "<p>Could not load tasks. Please try again.</p>";
    });
  }

  function submitTask(e, points, taskName) {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) { alert("❌ Please login first."); return; }
    
    const fileInput = e.target.querySelector('input[type="file"]');
    const file = fileInput.files[0];
    
    if (!file) {
        alert("❌ Please select a screenshot.");
        return;
    }
      
    const userRef = database.ref('users/' + user.uid);
    userRef.transaction((currentData) => {
        if (currentData) {
          currentData.balance = (currentData.balance || 0) + points;
          currentData.tasks = (currentData.tasks || 0) + 1;
        }
        return currentData;
    });
      
    alert("📷 Screenshot submitted for review. You earned " + points + " points!");
    e.target.reset(); // Clear the form

    const caption = `<b>New Task Submission!</b>\n<b>User:</b> ${user.email}\n<b>Task Name:</b> ${taskName}`;
    userRef.once('value').then(snapshot => {
        const userData = snapshot.val();
        // Send screenshot to the main admin chat, not the user's chat
        sendTelegramImageNotification(CHAT_ID, file, caption);
    });
  }

  function submitWithdraw(e) {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) { alert("❌ Please login first."); return; }

    const amount = parseInt(document.getElementById("amount").value);
    const number = document.getElementById("number").value;
    const minWithdraw = adminConfig.minWithdraw || 0;
    
    if (amount < minWithdraw) {
        alert(`❌ Minimum withdraw amount is ${minWithdraw}.`);
        return;
    }
      
    const userRef = database.ref('users/' + user.uid);
    userRef.once('value').then(snapshot => {
        const currentData = snapshot.val();
        const currentBalance = currentData ? currentData.balance : 0;
          
        if (amount > currentBalance) {
          alert("❌ Not enough balance.");
          return;
        }
          
        userRef.transaction((data) => {
            if (data) {
                data.withdraw = (data.withdraw || 0) + amount;
                data.balance = (data.balance || 0) - amount;
            }
            return data;
        });

        alert("✅ Withdraw request submitted! It will be processed soon.");
        document.getElementById("number").value = '';
        document.getElementById("amount").value = '';

        if (currentData && currentData.chatId) {
            const withdrawMessage = `<b>New Withdraw Request!</b>\n<b>User:</b> ${user.email}\n<b>Number:</b> ${number}\n<b>Amount:</b> ${amount}\n<b>User Chat ID:</b> ${currentData.chatId}`;
            sendTelegramNotification(CHAT_ID, withdrawMessage);
        }
    });
  }

  window.onload = () => {
    const script = document.createElement('script');
    script.src = `//libtl.com/sdk.js`;
    script.setAttribute('data-zone', MONETAG_ZONE_ID);
    script.setAttribute('data-sdk', `show_${MONETAG_ZONE_ID}`);
    document.head.appendChild(script);

    const homeButton = document.querySelector('nav button:first-child');
    if (homeButton) {
      showSection('home', homeButton);
    }
  };
</script>
</body>
</html>
